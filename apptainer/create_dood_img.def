BootStrap: docker
From: ubuntu:22.04

%post

    apt -y update

    # Otherwise tzdata asks for input when installing in ubuntu 22.04.
    DEBIAN_FRONTEND=noninteractive apt install -y tzdata
    
    # Install the normal system packages that we want for ete4.
    apt -y install wget python3.10-full python3-pip ipython3 python-is-python3 \
       python3-requests  python3-brotli python3-bottle mafft git

    # Install Python packages using pip in a single command
    pip install --no-cache-dir \
        https://github.com/etetoolkit/ete/archive/ete4.zip \
        treeswift \
        cvxopt \
        numpy \
        FastRoot \
        eggnog-mapper \
        pandas \
        "numpy>='1.17.3,<1.25.0'" \
        scipy 

    # Download, extract, and install external tools
    cd /opt

    # Clone repositories
    git clone https://github.com/AnaHrnndz/OG_Delineation.git
    git clone https://github.com/AnaHrnndz/cpo_pipeline.git

    # Download and extract binary tools
    wget https://mmseqs.com/latest/mmseqs-linux-avx2.tar.gz
    wget https://github.com/refresh-bio/FAMSA/releases/download/v2.4.1/famsa-v2.4.1-x64_linux.tar.gz
    wget http://www.microbesonline.org/fasttree/FastTree -O FastTree

    tar xvf mmseqs-linux-avx2.tar.gz
    tar xvf famsa-v2.4.1-x64_linux.tar.gz

    # Move FastTree to its own bin directory and set permissions
    mkdir -p /opt/fasttree/bin
    mv FastTree /opt/fasttree/bin/
    chmod +x /opt/fasttree/bin/FastTree
    chmod +x /opt/OG_Delineation/og_delineation.py
    chmod +x /opt/cpo_pipeline/dood_viz/run_ete4_smartview.py

    # Clean up downloaded archives
    rm -f mmseqs-linux-avx2.tar.gz famsa-v2.4.1-x64_linux.tar.gz

%environment
    export LC_ALL=C
    export PATH="/opt/mmseqs/bin:/opt/fasttree/bin:/opt/OG_Delineation:/opt/cpo_pipeline/dood_viz:$PATH"
    export PYTHONPATH="/opt/cpo_pipeline/dood_viz:$PYTHONPATH"

%runscript
    exec python /opt/cpo_pipeline/dood_viz/run_ete4_smartview.py "$@"

%labels
    Author Ana HernÃ¡ndez Plaza

%help
    This is an Apptainer image to run the DOOD pipeline and its dependencies.