BootStrap: docker
From: ubuntu:22.04

%post
    # Set noninteractive frontend to avoid tzdata prompts
    export DEBIAN_FRONTEND=noninteractive

    # Update and install system dependencies in a single command
    apt-get update -y && \
    apt-get install -y --no-install-recommends \
        wget \
        python3.10-full \
        python3-pip \
        ipython3 \
        python-is-python3 \
        python3-requests \
        python3-numpy \
        python3-scipy \
        python3-brotli \
        python3-bottle \
        mafft \
        git \
        tzdata && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

    # Install Python packages using pip in a single command
    pip install --no-cache-dir \
        https://github.com/etetoolkit/ete/archive/ete4.zip \
        treeswift \
        cvxopt \
        numpy \
        FastRoot \
        eggnog-mapper

    # Download, extract, and install external tools
    cd /opt

    # Clone repositories
    git clone https://github.com/AnaHrnndz/OG_Delineation.git
    git clone https://github.com/AnaHrnndz/cpo_pipeline.git

    # Download and extract binary tools
    wget https://mmseqs.com/latest/mmseqs-linux-avx2.tar.gz
    wget https://github.com/refresh-bio/FAMSA/releases/download/v2.4.1/famsa-v2.4.1-x64_linux.tar.gz
    wget http://www.microbesonline.org/fasttree/FastTree -O FastTree

    tar xvf mmseqs-linux-avx2.tar.gz
    tar xvf famsa-v2.4.1-x64_linux.tar.gz

    # Move FastTree to its own bin directory and set permissions
    mkdir -p /opt/fasttree/bin
    mv FastTree /opt/fasttree/bin/
    chmod +x /opt/fasttree/bin/FastTree
    chmod +x /opt/OG_Delineation/og_delineation.py
    chmod +x /opt/cpo_pipeline/dood_viz/run_ete4_smartview.py

    # Clean up downloaded archives
    rm -f mmseqs-linux-avx2.tar.gz famsa-v2.4.1-x64_linux.tar.gz

%environment
    export LC_ALL=C
    export PATH="/opt/mmseqs/bin:/opt/fasttree/bin:/opt/OG_Delineation:/opt/cpo_pipeline/dood_viz:$PATH"
    export PYTHONPATH="/opt/cpo_pipeline/dood_viz:$PYTHONPATH"

%runscript
    exec python /opt/cpo_pipeline/dood_viz/run_ete4_smartview.py "$@"

%labels
    Author Ana Hern√°ndez Plaza

%help
    This is an Apptainer image to run the DOOD pipeline and its dependencies.